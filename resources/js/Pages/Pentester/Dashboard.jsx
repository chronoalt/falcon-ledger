import React, { useEffect, useState } from 'react';
import { Head, Link, usePage } from '@inertiajs/react';

export default function Dashboard() {
    const { auth } = usePage().props;
    const name = auth?.user?.name ?? 'user';

    const [projects, setProjects] = useState(null);
    const [error, setError] = useState(null);

    useEffect(() => {
        let cancelled = false;

        const loadProjects = async () => {
            try {
                const res = await fetch('/projects', {
                    method: 'GET',
                    headers: {
                        'X-Inertia': 'true',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin',
                });

                if (!res.ok) {
                    throw new Error(`Failed to load projects (status ${res.status})`);
                }

                const page = await res.json();
                if (cancelled) return;

                const all = page.props?.projects ?? [];
                setProjects(all);
            } catch (e) {
                if (!cancelled) {
                    console.error(e);
                    setError('Could not load recent projects.');
                    setProjects([]);
                }
            }
        };

        loadProjects();

        return () => {
            cancelled = true;
        };
    }, []);

    const recentProjects = (projects ?? []).slice(0, 3);

    return (
        <div className="space-y-8">
            <Head title="Dashboard" />

            <h1 className="text-4xl font-extrabold text-[#0050a4]">
                Welcome, {name}!
            </h1>

            <section className="rounded-2xl bg-[#c7d9f6] p-6 shadow-sm">
                <div className="flex items-center justify-between gap-4">
                    <h2 className="text-xl font-semibold text-[#03407c]">
                        Recent Projects
                    </h2>
                    <Link
                        href="/projects"
                        className="text-sm font-semibold text-[#004a98] hover:underline"
                    >
                        View all projects
                    </Link>
                </div>

                {projects === null && !error && (
                    <p className="mt-4 text-sm text-[#03549a]">
                        Loading recent projects…
                    </p>
                )}

                {error && (
                    <p className="mt-4 text-sm text-red-700">
                        {error}
                    </p>
                )}

                {projects !== null && projects.length === 0 && !error && (
                    <div className="mt-6 rounded-2xl bg-[#d8e4fb] p-6 text-center">
                        <Link
                            href="/projects"
                            className="text-lg font-semibold text-[#004a98] hover:underline"
                        >
                            Start project now!
                        </Link>
                        <p className="mt-2 text-sm text-[#03407c]">
                            Create your first project to begin tracking assets, targets, and findings.
                        </p>
                    </div>
                )}

                {recentProjects.length > 0 && (
                    <div className="mt-4 grid gap-4 md:grid-cols-3">
                        {recentProjects.map((project) => (
                            <Link
                                key={project.id}
                                href={project.links.show}
                                className="group block rounded-2xl bg-[#d8e4fb] p-4 transition hover:-translate-y-0.5 hover:shadow-md"
                            >
                                <h3 className="text-sm font-semibold text-[#f4562c] group-hover:underline">
                                    {project.title}
                                </h3>
                                {project.status && (
                                    <p className="mt-1 text-xs uppercase tracking-wide text-[#03549a]">
                                        {project.status}
                                    </p>
                                )}
                                {project.due_at && (
                                    <p className="mt-1 text-xs text-[#03549a]">
                                        Due: {project.due_at}
                                    </p>
                                )}
                                <p className="mt-2 line-clamp-3 text-xs text-[#03407c]">
                                    {project.description || 'No description provided.'}
                                </p>
                                <p className="mt-3 text-xs font-semibold text-[#004a98]">
                                    View project →
                                </p>
                            </Link>
                        ))}
                    </div>
                )}
            </section>
        </div>
    );
}
